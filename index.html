<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>토람 온라인 크리스타 검색</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>토람 온라인 크리스타 검색</h1>

  <div class="search-container">
    <!-- 이름 검색 -->
    <input type="text" id="nameInput" placeholder="이름을 입력하세요">

    <!-- 카테고리 선택 -->
    <div class="checkbox-group">
      <input type="checkbox" id="normal" value="normal">
      <label for="normal">노말</label>

      <input type="checkbox" id="enhanced_normal" value="enhanced_normal">
      <label for="enhanced_normal">노말 강화</label>

      <input type="checkbox" id="weapon" value="weapon">
      <label for="weapon">무기</label>

      <input type="checkbox" id="enhanced_weapon" value="enhanced_weapon">
      <label for="enhanced_weapon">무기 강화</label>

      <input type="checkbox" id="armor" value="armor">
      <label for="armor">갑옷</label>

      <input type="checkbox" id="enhanced_armor" value="enhanced_armor">
      <label for="enhanced_armor">갑옷 강화</label>

      <input type="checkbox" id="hat" value="hat">
      <label for="hat">모자</label>

      <input type="checkbox" id="enhanced_hat" value="enhanced_hat">
      <label for="enhanced_hat">모자 강화</label>

      <input type="checkbox" id="ring" value="ring">
      <label for="ring">반지</label>

      <input type="checkbox" id="enhanced_ring" value="enhanced_ring">
      <label for="enhanced_ring">반지 강화</label>
    </div>

    <!-- 옵션 검색 -->
    <div class="option-search">
      <!-- 옵션 종류 선택 -->
      <label for="optionType">옵션 종류:</label>
      <select id="optionType">
        <option value="none">옵션 선택 (없을 경우 무시)</option>
        <option value="STR%">STR%</option>
        <option value="STR">STR</option>
        <option value="DEX%">DEX%</option>
        <option value="DEX">DEX</option>
        <option value="INT%">INT%</option>
        <option value="INT">INT</option>
        <option value="AGI%">AGI%</option>
        <option value="AGI">AGI</option>
        <option value="VIT%">VIT%</option>
        <option value="VIT">VIT</option>
        <option value="최대HP%">최대HP%</option>
        <option value="최대HP">최대HP</option>
        <option value="최대MP%">최대MP%</option>
        <option value="최대MP">최대MP</option>
        <option value="공격MP회복%">공격MP회복%</option>
        <option value="공격MP회복">공격MP회복</option>
        <option value="HP자연회복%">HP자연회복%</option>
        <option value="MP자연회복%">MP자연회복%</option>
        <option value="안정률%">안정률%</option>
        <option value="명중">명중</option>
        <option value="명중%">명중%</option>
        <option value="절대명중%">절대명중%</option>
        <option value="회피">회피</option>
        <option value="회피%">회피%</option>
        <option value="절대회피%">절대회피%</option>
        <option value="예측%">예측%</option>
        <option value="방어무너뜨리기%">방어무너뜨리기%</option>
        <option value="ATK%">ATK%</option>
        <option value="ATK">ATK</option>
        <option value="MATK%">MATK%</option>
        <option value="MATK">MATK</option>
        <option value="MATK업(AGI%)">MATK업(AGI%)</option>
        <option value="무기ATK">무기ATK</option>
        <option value="무기ATK%">무기ATK%</option>
        <option value="근거리위력%">근거리위력%</option>
        <option value="원거리위력%">원거리위력%</option>
        <option value="발도공격%">발도공격%</option>
        <option value="발도공격">발도공격</option>
        <option value="물리관통%">물리관통%</option>
        <option value="마법관통%">마법관통%</option>
        <option value="물리추격%">물리추격%</option>
        <option value="마법추격%">마법추격%</option>
        <option value="크리티컬률%">크리티컬률%</option>
        <option value="크리티컬률">크리티컬률</option>
        <option value="크리티컬데미지%">크리티컬데미지%</option>
        <option value="크리티컬데미지">크리티컬데미지</option>
        <option value="공격속도">공격속도</option>
        <option value="공격속도%">공격속도%</option>
        <option value="시전속도">시전속도</option>
        <option value="시전속도%">시전속도%</option>
        <option value="행동속도%">행동속도%</option>
        <option value="어그로%">어그로%</option>
        <option value="Guard력%">Guard력%</option>
        <option value="Guard회복%">Guard회복%</option>
        <option value="DEF">DEF</option>
        <option value="DEF%">DEF%</option>
        <option value="MDEF">MDEF</option>
        <option value="MDEF%">MDEF%</option>
        <option value="물리내성%">물리내성%</option>
        <option value="마법내성%">마법내성%</option>
        <option value="이상내성%%">이상내성%</option>
        <option value="무내성%">무내성%</option>
        <option value="불내성%">불내성%</option>
        <option value="물내성%">물내성%</option>
        <option value="바람내성%">바람내성%</option>
        <option value="땅내성%">땅내성%</option>
        <option value="빛내성%">빛내성%</option>
        <option value="어둠내성%">어둠내성%</option>
        <option value="무속성데미지%">무속성데미지%</option>
        <option value="불속성데미지%">불속성데미지%</option>
        <option value="물속성데미지%">물속성데미지%</option>
        <option value="바람속성데미지%">바람속성데미지%</option>
        <option value="땅속성데미지%">땅속성데미지%</option>
        <option value="빛속성데미지%">빛속성데미지%</option>
        <option value="어둠속성데미지%">어둠속성데미지%</option>
        <option value="Avoid회복%">Avoid회복%</option>
        <option value="범위경감%">범위경감%</option>
        <option value="주위경감%">주위경감%</option>
        <option value="사인경감%">사인경감%</option>
        <option value="탄환경감%">탄환경감%</option>
        <option value="돌진경감%">돌진경감%</option>
        <option value="장판경감%">장판경감%</option>
        <option value="운석경감%">운석경감%</option>
        <option value="직선경감%">직선경감%</option>
        <option value="부여정지(넘어짐)">부여정지(넘어짐)</option>
        <option value="부여정지(기죽음)">부여정지(기죽음)</option>
        <option value="부여정지(기절)">부여정지(기절)</option>
        <option value="물리배리어">물리배리어</option>
        <option value="마법배리어">마법배리어</option>
        <option value="비율배리어%">비율배리어%</option>
        <option value="배리어속도%">배리어속도%</option>
        <option value="데미지반사%">데미지반사%</option>
        <option value="반사데미지%">반사데미지%</option>
        <option value="복귀단축%">복귀단축%</option>
        <option value="획득EXP%">획득EXP%</option>
        <option value="드랍률%">드랍률%</option>
        <option value="도구속도">도구속도</option>
      </select>

      <!-- 기호 선택 -->
      <label for="symbol">기호:</label>
      <select id="symbol">
        <option value="=">=</option>
        <option value=">">></option>
        <option value="<"><</option>
        <option value=">=">>=</option>
        <option value="<="><=</option>
      </select>

      <!-- 값 입력 -->
      <label for="valueInput">값:</label>
      <input type="number" id="valueInput" placeholder="값을 입력하세요">
    </div>
  </div>

  <!-- 검색 버튼 -->
  <div class="button-container">
    <button id="searchButton">검색</button>
    <button id="randomButton">랜덤크리</button>
  </div>
  
  <!-- 결과 출력 영역 -->
  <div id="searchResults"></div>

  <button id="githubButton">업데이트 내역 확인</button>

  <script>
    // 카테고리별 이미지 매핑
    const imageMap = {
      normal: 'CrystaImg/normal.png',
      enhanced_normal: 'CrystaImg/enhanced_normal.png',
      weapon: 'CrystaImg/weapon.png',
      enhanced_weapon: 'CrystaImg/enhanced_weapon.png',
      armor: 'CrystaImg/armor.png',
      enhanced_armor: 'CrystaImg/enhanced_armor.png',
      hat: 'CrystaImg/hat.png',
      enhanced_hat: 'CrystaImg/enhanced_hat.png',
      ring: 'CrystaImg/ring.png',
      enhanced_ring: 'CrystaImg/enhanced_ring.png'
    };
  
    // 카테고리별 JSON 파일 경로 설정
    function getJsonFilePath(category) {
      const categoryMap = {
        normal: 'CrystaData/normal.json',
        weapon: 'CrystaData/weapon.json',
        armor: 'CrystaData/armor.json',
        enhanced_normal: 'CrystaData/enhanced_normal.json',
        enhanced_weapon: 'CrystaData/enhanced_weapon.json',
        enhanced_armor: 'CrystaData/enhanced_armor.json',
        hat: 'CrystaData/hat.json',
        enhanced_hat: 'CrystaData/enhanced_hat.json',
        ring: 'CrystaData/ring.json',
        enhanced_ring: 'CrystaData/enhanced_ring.json'
      };
      return categoryMap[category] || null;
    }
  
    document.getElementById('searchButton').addEventListener('click', () => {
      const nameQuery = document.getElementById('nameInput').value.toLowerCase();
      const selectedCategories = Array.from(document.querySelectorAll('.checkbox-group input:checked'))
        .map(input => input.value);
  
      // 옵션 값과 기호 가져오기
      const optionType = document.getElementById('optionType').value;
      const symbol = document.getElementById('symbol').value;
      const value = document.getElementById('valueInput').value;
  
      // 여러 개의 JSON 파일을 가져오는 Promise 배열 생성
      const fetchPromises = selectedCategories.length === 0
        ? [Promise.resolve({ category: '전체', data: [] })]  // 카테고리가 없을 때는 전체 검색으로 처리
        : selectedCategories.map(category => {
            const jsonFilePath = getJsonFilePath(category);
            if (jsonFilePath) {
              return fetch(jsonFilePath)
                .then(response => response.json())
                .then(data => ({ category, data }))  // 데이터와 카테고리 함께 반환
                .catch(error => {
                  console.error(`Failed to load ${category} JSON file`, error);
                  return { category, data: [] };
                });
            }
            return Promise.resolve({ category, data: [] });  // 해당 카테고리 파일이 없을 경우 빈 배열 반환
        });
  
      // 모든 카테고리 JSON 파일 가져오기
      Promise.all(fetchPromises)
        .then(results => {
          // 가져온 데이터를 하나로 병합
          const mergedData = results.flatMap(result => result.data);
  
          // 필터링 (이름 검색 및 옵션 선택)
          const filteredData = mergedData.filter(item => {
            // 옵션 선택 (없을 경우 무시): 선택된 옵션이 'none'일 경우, 옵션 조건 무시
            const optionMatches = optionType === 'none' || item.option.split('&').some(option => {
              const regex = new RegExp(`(${optionType})`); // optionType을 정규식으로 생성
              const match = option.match(regex);
  
              if (match) {
                // optionType이 포함된 부분 뒤에 %가 있는지 확인
                const index = option.indexOf(match[0]);
                const nextChar = option[index + match[0].length]; // optionType 뒤의 문자 확인
  
                if (nextChar === '%') {
                  return false; // %가 있으면 제외
                }

                if (index-1 >= 0 && option[index-1]!=')' && option[index-1]!='&') {
                  return false; // 앞글자가 )이나 &이 아닌경우 제외
                }
  
                // 기호에 맞는 비교 연산 수행
                const numberValue = parseFloat(option.match(/([+-]?\d+(\.\d+)?)/)[0]);
                const comparisonValue = parseFloat(value);
                switch (symbol) {
                  case '=':
                    return numberValue === comparisonValue;
                  case '>':
                    return numberValue > comparisonValue;
                  case '<':
                    return numberValue < comparisonValue;
                  case '>=':
                    return numberValue >= comparisonValue;
                  case '<=':
                    return numberValue <= comparisonValue;
                  default:
                    return false;
                }
              }
              return false;
            });
  
            return (nameQuery === "" || item.name.toLowerCase().includes(nameQuery)) && optionMatches;
          });
  
          // 결과 출력
          const resultsDiv = document.getElementById('searchResults');
          resultsDiv.innerHTML = filteredData.length > 0
            ? filteredData.map(item => {
                // 해당 아이템의 카테고리에 맞는 이미지 경로 찾기
                const categoryImage = imageMap[results.find(r => r.data.includes(item)).category];
                return ` 
                  <div class="crysta-item">
                    <h3>${item.name}</h3>
                    <p>${item.option}</p>
                    ${item.enhance ? `<p><strong>강화 대상:</strong> ${item.enhance}</p>` : ''}
                    <img src="${categoryImage}" alt="${item.name}">
                  </div>`; 
              }).join('') 
            : '<p>검색 결과가 없습니다.</p>';
        })
        .catch(error => {
          console.error('Error fetching JSON files:', error);
        });
    });

    document.getElementById('randomButton').addEventListener('click', () => {
      const allCategories = [
        'normal',
        'enhanced_normal',
        'weapon',
        'enhanced_weapon',
        'armor',
        'enhanced_armor',
        'hat',
        'enhanced_hat',
        'ring',
        'enhanced_ring'
      ];

      // 랜덤한 카테고리 선택
      const randomCategory = allCategories[Math.floor(Math.random() * allCategories.length)];
      const jsonFilePath = getJsonFilePath(randomCategory);

      // 해당 카테고리의 JSON만 불러오기
      fetch(jsonFilePath)
        .then(response => response.json())
        .then(data => {
          if (data.length === 0) {
            document.getElementById('searchResults').innerHTML = '<p>데이터가 없습니다.</p>';
            return;
          }

          // 해당 카테고리 안에서 하나 랜덤 선택
          const randomItem = data[Math.floor(Math.random() * data.length)];
          const categoryImage = imageMap[randomCategory];

          // 출력
          document.getElementById('searchResults').innerHTML = `
            <div class="crysta-item">
              <h3>${randomItem.name}</h3>
              <p>${randomItem.option}</p>
              ${randomItem.enhance ? `<p><strong>강화 대상:</strong> ${randomItem.enhance}</p>` : ''}
              <img src="${categoryImage}" alt="${randomItem.name}">
            </div>
          `;
        })
        .catch(error => {
          console.error(`Failed to load ${randomCategory} JSON file`, error);
          document.getElementById('searchResults').innerHTML = '<p>데이터 로딩 실패</p>';
        });
    });

    document.getElementById("githubButton").addEventListener("click", function () {
    window.open("https://github.com/jjh030325/ToramCrystaSearch", "_blank");
  });
  </script>
</body>
</html>
