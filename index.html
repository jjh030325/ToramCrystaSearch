<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>토람 온라인 크리스타 검색</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>토람 온라인 크리스타 검색</h1>

  <div class="search-container">
    <!-- 이름 검색 -->
    <input type="text" id="nameInput" placeholder="이름을 입력하세요">

    <!-- 카테고리 선택 -->
    <div class="checkbox-group">
      <input type="checkbox" id="normal" value="normal">
      <label for="normal">노말</label>

      <input type="checkbox" id="enhanced_normal" value="enhanced_normal">
      <label for="enhanced_normal">노말 강화</label>

      <input type="checkbox" id="weapon" value="weapon">
      <label for="weapon">무기</label>

      <input type="checkbox" id="enhanced_weapon" value="enhanced_weapon">
      <label for="enhanced_weapon">무기 강화</label>

      <input type="checkbox" id="armor" value="armor">
      <label for="armor">갑옷</label>

      <input type="checkbox" id="enhanced_armor" value="enhanced_armor">
      <label for="enhanced_armor">갑옷 강화</label>

      <input type="checkbox" id="hat" value="hat">
      <label for="hat">모자</label>

      <input type="checkbox" id="enhanced_hat" value="enhanced_hat">
      <label for="enhanced_hat">모자 강화</label>

      <input type="checkbox" id="ring" value="ring">
      <label for="ring">반지</label>

      <input type="checkbox" id="enhanced_ring" value="enhanced_ring">
      <label for="enhanced_ring">반지 강화</label>
    </div>

    <!-- 옵션 검색 -->
    <div class="option-search">
      <!-- 옵션 종류 선택 -->
      <label for="optionType">옵션 종류:</label>
      <select id="optionType">
        <option value="none">옵션 선택 (없을 경우 무시)</option>
        <option value="공격MP회복">공격MP회복</option>
        <option value="배리어속도%">배리어속도%</option>
        <option value="물내성%">물내성%</option>
        <option value="최대MP">최대MP</option>
        <option value="ATK%">ATK%</option>
        <option value="발도공격%">발도공격%</option>
        <option value="무내성%">무내성%</option>
        <option value="Guard회복%">Guard회복%</option>
        <option value="물리내성%">물리내성%</option>
        <option value="최대HP%">최대HP%</option>
        <option value="Avoid회복%">Avoid회복%</option>
        <option value="마법내성%">마법내성%</option>
        <option value="MATK%">MATK%</option>
      </select>

      <!-- 기호 선택 -->
      <label for="symbol">기호:</label>
      <select id="symbol">
        <option value="=">=</option>
        <option value=">">></option>
        <option value="<"><</option>
        <option value=">=">>=</option>
        <option value="<="><=</option>
      </select>

      <!-- 값 입력 -->
      <label for="valueInput">값:</label>
      <input type="number" id="valueInput" placeholder="값을 입력하세요">
    </div>
  </div>

  <!-- 검색 버튼 -->
  <button id="searchButton">검색</button>

  <!-- 결과 출력 영역 -->
  <div id="searchResults"></div>

  <script>
    // 카테고리별 이미지 매핑
    const imageMap = {
      normal: 'CrystaImg/normal.png',
      enhanced_normal: 'CrystaImg/enhanced_normal.png',
      weapon: 'CrystaImg/weapon.png',
      enhanced_weapon: 'CrystaImg/enhanced_weapon.png',
      armor: 'CrystaImg/armor.png',
      enhanced_armor: 'CrystaImg/enhanced_armor.png',
      hat: 'CrystaImg/hat.png',
      enhanced_hat: 'CrystaImg/enhanced_hat.png',
      ring: 'CrystaImg/ring.png',
      enhanced_ring: 'CrystaImg/enhanced_ring.png'
    };

    // 카테고리별 JSON 파일 경로 설정
    function getJsonFilePath(category) {
      const categoryMap = {
        normal: 'CrystaData/normal.json',
        weapon: 'CrystaData/weapon.json',
        armor: 'CrystaData/armor.json',
        enhanced_normal: 'CrystaData/enhanced_normal.json',
        enhanced_weapon: 'CrystaData/enhanced_weapon.json',
        enhanced_armor: 'CrystaData/enhanced_armor.json',
        hat: 'CrystaData/hat.json',
        enhanced_hat: 'CrystaData/enhanced_hat.json',
        ring: 'CrystaData/ring.json',
        enhanced_ring: 'CrystaData/enhanced_ring.json'
      };
      return categoryMap[category] || null;
    }

    document.getElementById('searchButton').addEventListener('click', () => {
      const nameQuery = document.getElementById('nameInput').value.toLowerCase();
      const selectedCategories = Array.from(document.querySelectorAll('.checkbox-group input:checked'))
        .map(input => input.value);

      // 옵션 값과 기호 가져오기
      const optionType = document.getElementById('optionType').value;
      const symbol = document.getElementById('symbol').value;
      const value = document.getElementById('valueInput').value;

      // 여러 개의 JSON 파일을 가져오는 Promise 배열 생성
      const fetchPromises = selectedCategories.length === 0
        ? [Promise.resolve({ category: '전체', data: [] })]  // 카테고리가 없을 때는 전체 검색으로 처리
        : selectedCategories.map(category => {
            const jsonFilePath = getJsonFilePath(category);
            if (jsonFilePath) {
              return fetch(jsonFilePath)
                .then(response => response.json())
                .then(data => ({ category, data }))  // 데이터와 카테고리 함께 반환
                .catch(error => {
                  console.error(`Failed to load ${category} JSON file`, error);
                  return { category, data: [] };
                });
            }
            return Promise.resolve({ category, data: [] });  // 해당 카테고리 파일이 없을 경우 빈 배열 반환
        });

      // 모든 카테고리 JSON 파일 가져오기
      Promise.all(fetchPromises)
        .then(results => {
          // 가져온 데이터를 하나로 병합
          const mergedData = results.flatMap(result => result.data);

          // 필터링 (이름 검색 및 옵션 선택)
          const filteredData = mergedData.filter(item => {
            // 옵션 선택 (없을 경우 무시): 선택된 옵션이 'none'일 경우, 옵션 조건 무시
            const optionMatches = optionType === "none" || item.option.split('&').some(option => {
              const regex = /([+-]?\d+(\.\d+)?)/; // + 또는 - 기호와 숫자를 추출하는 정규식
              const match = option.match(regex);
              if (match) {
                const numberValue = parseFloat(match[0]);
                if (optionType !== "none" && option.includes(optionType)) {
                  // 기호에 맞는 비교 연산 수행
                  const comparisonValue = parseFloat(value);
                  switch (symbol) {
                    case '=':
                      return numberValue === comparisonValue;
                    case '>':
                      return numberValue > comparisonValue;
                    case '<':
                      return numberValue < comparisonValue;
                    case '>=':
                      return numberValue >= comparisonValue;
                    case '<=':
                      return numberValue <= comparisonValue;
                    default:
                      return false;
                  }
                }
              }
              return false;
            });

            return (nameQuery === "" || item.name.toLowerCase().includes(nameQuery)) && optionMatches;
          });

          // 결과 출력
          const resultsDiv = document.getElementById('searchResults');
          resultsDiv.innerHTML = filteredData.length > 0
            ? filteredData.map(item => {
                // 해당 아이템의 카테고리에 맞는 이미지 경로 찾기
                const categoryImage = imageMap[results.find(r => r.data.includes(item)).category];
                return ` 
                  <div class="crysta-item">
                    <h3>${item.name}</h3>
                    <p>${item.option}</p>
                    <img src="${categoryImage}" alt="${item.name}">
                  </div>`; 
              }).join('') 
            : '<p>검색 결과가 없습니다.</p>';
        })
        .catch(error => {
          console.error('Error fetching JSON files:', error);
        });
    });
  </script>
</body>
</html>
